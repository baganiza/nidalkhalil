<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Manage Products</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f9; }
  #loginForm, #adminPanel { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  input, textarea, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
  button { cursor: pointer; background-color: #007bff; color: white; border: none; }
  button:hover { background-color: #0056b3; }
  #progressContainer { display: none; margin-top: 10px; }
  #progressBar { width: 100%; height: 20px; background: #ddd; border-radius: 5px; overflow: hidden; }
  #progressFill { height: 100%; background: #28a745; width: 0%; color: white; text-align: center; line-height: 20px; font-size: 12px; }
</style>
</head>
<body>

<div id="loginForm">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="adminPanel" style="display:none;">
  <h2>Admin Panel - Manage Products</h2>
  <button id="logoutBtn">Logout</button>
  <h3>Current Products</h3>
  <table id="productsTable">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Price</th><th>Description</th><th>Image</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <h3>Add / Edit Product</h3>
  <input type="hidden" id="productId" />
  <input type="text" id="productName" placeholder="Name" />
  <input type="number" id="productPrice" placeholder="Price" />
  <textarea id="productDescription" placeholder="Description"></textarea>
  <input type="file" id="productImage" accept="image/*" />
  
  <div id="progressContainer">
    <div id="progressBar">
      <div id="progressFill">0%</div>
    </div>
  </div>

  <button id="saveProductBtn">Save Product</button>
  <p id="productMessage" style="color:green;"></p>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCcWgFDzs95TbVU7v5h_5O0lNzZvBlL90o",
    authDomain: "baganiza-66bf0.firebaseapp.com",
    projectId: "baganiza-66bf0",
    storageBucket: "baganiza-66bf0.appspot.com",
    messagingSenderId: "1016966032123",
    appId: "1:1016966032123:web:fbffd397c7d8494fa79e5e"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.getAuth();
  const db = firebase.getFirestore();
  const storage = firebase.getStorage();

  const loginForm = document.getElementById('loginForm');
  const adminPanel = document.getElementById('adminPanel');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginError = document.getElementById('loginError');
  const productsTableBody = document.querySelector('#productsTable tbody');
  const saveProductBtn = document.getElementById('saveProductBtn');
  const productIdInput = document.getElementById('productId');
  const productNameInput = document.getElementById('productName');
  const productPriceInput = document.getElementById('productPrice');
  const productDescriptionInput = document.getElementById('productDescription');
  const productImageInput = document.getElementById('productImage');
  const progressContainer = document.getElementById('progressContainer');
  const progressFill = document.getElementById('progressFill');
  const productMessage = document.getElementById('productMessage');

  firebase.onAuthStateChanged(auth, user => {
    if(user){
      loginForm.style.display = 'none';
      adminPanel.style.display = 'block';
      loadProducts();
    } else {
      loginForm.style.display = 'block';
      adminPanel.style.display = 'none';
    }
  });

  loginBtn.addEventListener('click', () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    loginError.textContent = '';
    firebase.signInWithEmailAndPassword(auth, email, password).catch(err => {
      loginError.textContent = err.message;
    });
  });

  logoutBtn.addEventListener('click', () => {
    firebase.signOut(auth);
    clearForm();
  });

  function loadProducts(){
    productsTableBody.innerHTML = '';
    firebase.getDocs(firebase.collection(db, 'products')).then(snapshot => {
      snapshot.forEach(doc => {
        const product = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${doc.id}</td>
          <td>${product.name}</td>
          <td>${product.price}</td>
          <td>${product.description}</td>
          <td>${product.imageURL ? `<img src="${product.imageURL}" width="50" />` : 'No Image'}</td>
          <td>
            <button onclick="editProduct('${doc.id}')">Edit</button>
            <button onclick="deleteProduct('${doc.id}')">Delete</button>
          </td>
        `;
        productsTableBody.appendChild(tr);
      });
    });
  }

  saveProductBtn.addEventListener('click', () => {
    const id = productIdInput.value;
    const name = productNameInput.value.trim();
    const price = parseFloat(productPriceInput.value);
    const description = productDescriptionInput.value.trim();
    const file = productImageInput.files[0];

    if(!name || !price || !description){
      alert('Please fill all fields');
      return;
    }

    if(file){
      const fileName = Date.now() + '_' + file.name;
      const storageRef = firebase.ref(storage, 'productImages/' + fileName);
      const uploadTask = firebase.uploadBytesResumable(storageRef, file);

      progressContainer.style.display = 'block';

      uploadTask.on('state_changed',
        snapshot => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressFill.style.width = progress + '%';
          progressFill.textContent = Math.round(progress) + '%';
        },
        error => {
          console.error('Upload failed:', error);
          saveProductToDB(id, name, price, description, null); // save without image
        },
        () => {
          firebase.getDownloadURL(uploadTask.snapshot.ref).then(downloadURL => {
            saveProductToDB(id, name, price, description, downloadURL);
          });
        }
      );
    } else {
      saveProductToDB(id, name, price, description, null);
    }
  });

  function saveProductToDB(id, name, price, description, imageURL){
    const data = { name, price, description };
    if(imageURL) data.imageURL = imageURL;

    const saveAction = id
      ? firebase.setDoc(firebase.doc(db, 'products', id), data)
      : firebase.addDoc(firebase.collection(db, 'products'), data);

    saveAction.then(() => {
      productMessage.textContent = 'Product saved successfully.';
      clearForm();
      loadProducts();
      progressContainer.style.display = 'none';
      progressFill.style.width = '0%';
    });
  }

  window.editProduct = function(id){
    firebase.getDoc(firebase.doc(db, 'products', id)).then(docSnap => {
      if(docSnap.exists()){
        const product = docSnap.data();
        productIdInput.value = id;
        productNameInput.value = product.name;
        productPriceInput.value = product.price;
        productDescriptionInput.value = product.description;
      }
    });
  }

  window.deleteProduct = function(id){
    if(confirm('Are you sure you want to delete this product?')){
      firebase.deleteDoc(firebase.doc(db, 'products', id)).then(() => {
        loadProducts();
      });
    }
  }

  function clearForm(){
    productIdInput.value = '';
    productNameInput.value = '';
    productPriceInput.value = '';
    productDescriptionInput.value = '';
    productImageInput.value = '';
    productMessage.textContent = '';
  }
</script>
</body>
</html>
