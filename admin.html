<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel - Manage Products</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #loginForm, #adminPanel { max-width: 600px; margin: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; }
  th { background-color: #f2f2f2; }
  input, textarea, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; }
  button { cursor: pointer; }
  #uploadProgress { width: 100%; background: #eee; height: 20px; margin-top: 5px; display: none; }
  #uploadProgressBar { height: 100%; background: green; width: 0%; }
</style>
</head>
<body>

<div id="loginForm">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="adminPanel" style="display:none;">
  <h2>Admin Panel - Manage Products</h2>
  <button id="logoutBtn">Logout</button>

  <h3>Current Products</h3>
  <table id="productsTable">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Price</th><th>Description</th><th>Image</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Add / Edit Product</h3>
  <input type="hidden" id="productId" />
  <input type="text" id="productName" placeholder="Name" />
  <input type="number" id="productPrice" placeholder="Price" />
  <textarea id="productDescription" placeholder="Description"></textarea>
  <input type="file" id="productImage" accept="image/*" />

  <div id="uploadProgress">
    <div id="uploadProgressBar"></div>
  </div>

  <button id="saveProductBtn">Save Product</button>
  <p id="productMessage" style="color:green;"></p>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCcWgFDzs95TbVU7v5h_5O0lNzZvBlL90o",
  authDomain: "baganiza-66bf0.firebaseapp.com",
  projectId: "baganiza-66bf0",
  storageBucket: "baganiza-66bf0.appspot.com",
  messagingSenderId: "1016966032123",
  appId: "1:1016966032123:web:fbffd397c7d8494fa79e5e"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const loginForm = document.getElementById('loginForm');
const adminPanel = document.getElementById('adminPanel');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginError = document.getElementById('loginError');
const productsTableBody = document.querySelector('#productsTable tbody');
const saveProductBtn = document.getElementById('saveProductBtn');
const productIdInput = document.getElementById('productId');
const productNameInput = document.getElementById('productName');
const productPriceInput = document.getElementById('productPrice');
const productDescriptionInput = document.getElementById('productDescription');
const productImageInput = document.getElementById('productImage');
const productMessage = document.getElementById('productMessage');
const uploadProgress = document.getElementById('uploadProgress');
const uploadProgressBar = document.getElementById('uploadProgressBar');

auth.onAuthStateChanged(user => {
  if(user){
    loginForm.style.display = 'none';
    adminPanel.style.display = 'block';
    loadProducts();
  } else {
    loginForm.style.display = 'block';
    adminPanel.style.display = 'none';
  }
});

loginBtn.addEventListener('click', () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  loginError.textContent = '';
  auth.signInWithEmailAndPassword(email, password)
    .catch(err => { loginError.textContent = err.message; });
});

logoutBtn.addEventListener('click', () => {
  auth.signOut();
  clearForm();
});

function loadProducts(){
  productsTableBody.innerHTML = '';
  db.collection('products').get().then(snapshot => {
    snapshot.forEach(doc => {
      const product = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${doc.id}</td>
        <td>${product.name}</td>
        <td>${product.price}</td>
        <td>${product.description}</td>
        <td>${product.imageUrl ? `<img src="${product.imageUrl}" width="50">` : 'No image'}</td>
        <td>
          <button onclick="editProduct('${doc.id}')">Edit</button>
          <button onclick="deleteProduct('${doc.id}')">Delete</button>
        </td>
      `;
      productsTableBody.appendChild(tr);
    });
  });
}

saveProductBtn.addEventListener('click', () => {
  const id = productIdInput.value;
  const name = productNameInput.value.trim();
  const price = parseFloat(productPriceInput.value);
  const description = productDescriptionInput.value.trim();
  const imageFile = productImageInput.files[0];

  if(!name || !price || !description){
    alert('Please fill all fields');
    return;
  }

  if(imageFile){
    uploadProgress.style.display = 'block';
    uploadProgressBar.style.width = '0%';

    const storageRef = storage.ref('product-images/' + Date.now() + '_' + imageFile.name);
    const uploadTask = storageRef.put(imageFile);

    uploadTask.on('state_changed', 
      (snapshot) => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        uploadProgressBar.style.width = progress + '%';
      },
      (error) => {
        console.error("Image upload failed:", error);
        alert("Image upload failed. Saving without image.");
        saveToDB(id, name, price, description, null);
      },
      async () => {
        const imageUrl = await uploadTask.snapshot.ref.getDownloadURL();
        saveToDB(id, name, price, description, imageUrl);
      }
    );
  } else {
    saveToDB(id, name, price, description, null);
  }
});

function saveToDB(id, name, price, description, imageUrl){
  const data = { name, price, description };
  if(imageUrl) data.imageUrl = imageUrl;

  if(id){
    db.collection('products').doc(id).set(data)
      .then(() => {
        productMessage.textContent = 'Product updated successfully.';
        clearForm();
        loadProducts();
      });
  } else {
    const newId = db.collection('products').doc().id;
    db.collection('products').doc(newId).set(data)
      .then(() => {
        productMessage.textContent = 'Product added successfully.';
        clearForm();
        loadProducts();
      });
  }
}

function editProduct(id){
  db.collection('products').doc(id).get().then(doc => {
    if(doc.exists){
      const product = doc.data();
      productIdInput.value = id;
      productNameInput.value = product.name;
      productPriceInput.value = product.price;
      productDescriptionInput.value = product.description;
      productImageInput.value = '';
    }
  });
}

function deleteProduct(id){
  if(confirm('Are you sure you want to delete this product?')){
    db.collection('products').doc(id).delete().then(() => {
      loadProducts();
    });
  }
}

function clearForm(){
  productIdInput.value = '';
  productNameInput.value = '';
  productPriceInput.value = '';
  productDescriptionInput.value = '';
  productImageInput.value = '';
  uploadProgress.style.display = 'none';
  uploadProgressBar.style.width = '0%';
  productMessage.textContent = '';
}
</script>
</body>
</html>
