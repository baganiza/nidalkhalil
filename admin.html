<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Manage Products</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    label { display: block; margin-top: 10px; }
    input, textarea { width: 300px; padding: 5px; }
    button { margin-top: 10px; padding: 10px 20px; }
    table { border-collapse: collapse; margin-top: 20px; width: 80%; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
  </style>
</head>
<body>
  <h1>Admin Panel - Manage Products</h1>

  <div id="loginDiv">
    <h2>Login</h2>
    <label>Username: <input type="text" id="username" /></label>
    <label>Password: <input type="password" id="password" /></label>
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div id="adminDiv" class="hidden">
    <button onclick="logout()">Logout</button>
    <h2>Current Products</h2>
    <table id="productsTable">
      <thead>
        <tr><th>ID</th><th>Name</th><th>Price</th><th>Description</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Add / Edit Product</h2>
    <input type="hidden" id="productId" />
    <label>Name: <input type="text" id="productName" /></label>
    <label>Price: <input type="number" id="productPrice" /></label>
    <label>Description: <textarea id="productDescription"></textarea></label>
    <button onclick="saveProduct()">Save Product</button>
    <p id="statusMsg" style="color:green;"></p>
  </div>

  <script>
    const GITHUB_USERNAME = 'baganiza'; // عدّل إلى اسم المستخدم الخاص بك
    const REPO_NAME = 'nidalkhalil';    // عدّل إلى اسم الريبو الخاص بك
    const FILE_PATH = 'products.json';  // مكان ملف المنتجات في الريبو
    const BRANCH = 'main';               // فرع الريبو (غالبا main أو master)

    // مهم: أدخل توكن GitHub الخاص بك هنا (احرص على عدم نشر الصفحة للعامة)
    const GITHUB_TOKEN = 'YOUR_PERSONAL_ACCESS_TOKEN_HERE';

    let products = [];

    // عناصر DOM
    const loginDiv = document.getElementById('loginDiv');
    const adminDiv = document.getElementById('adminDiv');
    const loginError = document.getElementById('loginError');
    const statusMsg = document.getElementById('statusMsg');

    // تسجيل دخول بسيط (غير آمن، فقط للعرض)
    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if(username === 'admin' && password === '1234') {
        loginDiv.classList.add('hidden');
        adminDiv.classList.remove('hidden');
        loadProducts();
      } else {
        loginError.textContent = 'Invalid username or password';
      }
    }

    function logout() {
      loginDiv.classList.remove('hidden');
      adminDiv.classList.add('hidden');
      loginError.textContent = '';
      statusMsg.textContent = '';
      clearForm();
    }

    // تحميل المنتجات من GitHub API
    async function loadProducts() {
      statusMsg.textContent = 'Loading products...';
      const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}?ref=${BRANCH}`;
      try {
        const res = await fetch(url);
        if(!res.ok) throw new Error('Failed to fetch products.json');
        const data = await res.json();
        const content = atob(data.content);
        products = JSON.parse(content);
        window.productsSHA = data.sha; // مهم لحفظ التغييرات
        renderProductsTable();
        statusMsg.textContent = '';
      } catch (error) {
        statusMsg.style.color = 'red';
        statusMsg.textContent = error.message;
      }
    }

    function renderProductsTable() {
      const tbody = document.querySelector('#productsTable tbody');
      tbody.innerHTML = '';
      products.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>${p.price}</td>
          <td>${p.description}</td>
          <td>
            <button onclick="editProduct(${p.id})">Edit</button>
            <button onclick="deleteProduct(${p.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function clearForm() {
      document.getElementById('productId').value = '';
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productDescription').value = '';
    }

    function editProduct(id) {
      const p = products.find(x => x.id === id);
      if(!p) return;
      document.getElementById('productId').value = p.id;
      document.getElementById('productName').value = p.name;
      document.getElementById('productPrice').value = p.price;
      document.getElementById('productDescription').value = p.description;
      statusMsg.textContent = '';
    }

    async function deleteProduct(id) {
      if(!confirm('Are you sure you want to delete this product?')) return;
      products = products.filter(p => p.id !== id);
      await saveProductsToGitHub();
    }

    async function saveProduct() {
      const idInput = document.getElementById('productId').value;
      const name = document.getElementById('productName').value.trim();
      const price = Number(document.getElementById('productPrice').value);
      const description = document.getElementById('productDescription').value.trim();

      if(!name || !price || !description) {
        statusMsg.style.color = 'red';
        statusMsg.textContent = 'Please fill all fields correctly.';
        return;
      }

      if(idInput) {
        // تعديل منتج موجود
        const id = Number(idInput);
        const idx = products.findIndex(p => p.id === id);
        if(idx !== -1) {
          products[idx] = { id, name, price, description };
        }
      } else {
        // إضافة منتج جديد
        const maxId = products.length ? Math.max(...products.map(p => p.id)) : 0;
        products.push({ id: maxId + 1, name, price, description });
      }

      await saveProductsToGitHub();
    }

    async function saveProductsToGitHub() {
      statusMsg.style.color = 'black';
      statusMsg.textContent = 'Saving products...';

      const url = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
      const message = 'Update products.json via Admin Panel';
      const content = btoa(JSON.stringify(products, null, 2));
      const sha = window.productsSHA;

      const body = {
        message,
        content,
        branch: BRANCH,
        sha
      };

      try {
        const res = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if(!res.ok) {
          throw new Error('Failed to save products.json to GitHub.');
        }
        const data = await res.json();
        window.productsSHA = data.content.sha; // تحديث SHA بعد الحفظ
        renderProductsTable();
        clearForm();
        statusMsg.style.color = 'green';
        statusMsg.textContent = 'Products saved successfully!';
      } catch (error) {
        statusMsg.style.color = 'red';
        statusMsg.textContent = error.message;
      }
    }
  </script>
</body>
</html>
